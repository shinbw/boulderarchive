<script>
document.addEventListener('DOMContentLoaded', () => {
/* ===== ê³ ì • ì„¤ì • (ìˆ˜ì • X) ===== */
const CONFIG = { owner: 'shinbw', repo: 'boulderarchive', branch: 'main' };
/* ================================= */

const state = { path: '', items: [], sort: { key:'name', asc:true }, branchTried:false };
const $ = (sel, el=document) => el.querySelector(sel);

/* í•„ìš”í•œ ìš”ì†Œê°€ ì—†ìœ¼ë©´ ìë™ìœ¼ë¡œ ë§Œë“¤ì–´ì£¼ëŠ” ì•ˆì „íŒ */
function buildScaffoldIfMissing(){
  const need = {
    wrap: document.querySelector('.wrap'),
    search: document.getElementById('search'),
    rawBtn: document.getElementById('rawBtn'),
    crumbs: document.getElementById('breadcrumbs'),
    list: document.getElementById('list')
  };
  if (need.wrap && need.search && need.rawBtn && need.crumbs && need.list) return;

  // ìµœì†Œ UI ìƒì„±
  const wrap = need.wrap || document.createElement('div');
  wrap.className = 'wrap';
  wrap.style.maxWidth = '1100px';
  wrap.style.margin = '0 auto';
  wrap.style.padding = '16px';

  // ìƒë‹¨ ë°”
  const top = document.createElement('div');
  top.style.display = 'flex';
  top.style.gap = '8px';
  top.style.alignItems = 'center';
  top.style.marginBottom = '8px';
  top.innerHTML = `
    <input id="search" type="text" placeholder="ì´ í´ë”ì—ì„œ ì°¾ê¸°..." style="flex:1;min-width:220px;padding:8px 10px">
    <a id="rawBtn" class="btn" href="#" target="_blank" style="padding:8px 10px;border:1px solid #ccc;border-radius:8px;text-decoration:none">GitHubì—ì„œ ì—´ê¸°</a>
  `;

  const crumbs = document.createElement('nav');
  crumbs.id = 'breadcrumbs';
  crumbs.style.margin = '6px 0 12px 0';

  const table = document.createElement('table');
  table.style.width = '100%';
  const tbody = document.createElement('tbody');
  tbody.id = 'list';
  tbody.innerHTML = `<tr><td style="padding:12px;color:#888">UI ìŠ¤ìºí´ë“œ ìë™ ìƒì„±ë¨â€¦</td></tr>`;
  table.appendChild(tbody);

  // ì¡°ë¦½
  if (!need.wrap) document.body.appendChild(wrap);
  wrap.appendChild(top);
  wrap.appendChild(crumbs);
  wrap.appendChild(table);
}
buildScaffoldIfMissing();

/* ìš”ì†Œ ì°¸ì¡° (ìŠ¤ìºí´ë“œ ìƒì„± í›„ ë‹¤ì‹œ ì¡ê¸°) */
const listEl = $('#list');
const crumbsEl = $('#breadcrumbs');
const searchEl = $('#search');
const rawBtn = $('#rawBtn');

/* ì§„ë‹¨ ë°•ìŠ¤ */
const diag = document.createElement('div');
diag.className = 'hint';
diag.style.marginTop = '8px';
diag.style.color = '#888';
diag.textContent = 'ì§„ë‹¨: ì‹œì‘ë¨';
(document.querySelector('.wrap') || document.body).appendChild(diag);
function setDiag(msg){ diag.textContent = 'ì§„ë‹¨: ' + msg; }

/* API ìœ í‹¸ */
function apiUrl(path, branch){
  const clean = (path||'').replace(/^\/+|\/+$/g,'');
  const b = encodeURIComponent(branch||CONFIG.branch);
  return `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${clean}?ref=${b}&nocache=${Date.now()}`;
}
function ghTreeUrl(path, branch){
  const clean = (path||'').replace(/^\/+|\/+$/g,'');
  const p = clean? `/tree/${branch}/${clean}` : '';
  return `https://github.com/${CONFIG.owner}/${CONFIG.repo}${p}`;
}
async function getDefaultBranch(){
  const u = `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}?nocache=${Date.now()}`;
  const r = await fetch(u, { headers: { 'Accept': 'application/vnd.github+json' }});
  if(!r.ok) throw new Error(`ë ˆí¬ ì¡°íšŒ ì‹¤íŒ¨ ${r.status}`);
  const j = await r.json();
  return j.default_branch || 'main';
}

/* ë Œë”ë§ */
function sortItems(items){
  const {key,asc} = state.sort;
  const dir = asc? 1 : -1;
  const isDirFirst = (a,b)=> (a.type===b.type)?0 : (a.type==='dir'?-1:1);
  const byName = (a,b)=> a.name.localeCompare(b.name);
  const byType = (a,b)=> a.type.localeCompare(b.type) || byName(a,b);
  const bySize = (a,b)=> (a.size||0)-(b.size||0) || byName(a,b);
  const cmp = key==='type'? byType : key==='size'? bySize : byName;
  return items.slice().sort((a,b)=> isDirFirst(a,b) || dir*cmp(a,b));
}
function formatSize(bytes){
  if(bytes==null) return '-';
  const units=['B','KB','MB','GB']; let n=bytes, i=0; while(n>=1024 && i<units.length-1){ n/=1024; i++; }
  return (i? n.toFixed(1):n) + ' ' + units[i];
}
function iconOf(item){
  const ext = (item.name.split('.').pop()||'').toLowerCase();
  const isImg = ['png','jpg','jpeg','gif','webp','bmp','svg','avif'].includes(ext);
  const isPdf = ext==='pdf';
  if(item.type==='dir') return 'ğŸ“‚';
  if(isImg) return 'ğŸ–¼ï¸';
  if(isPdf) return 'ğŸ“„';
  return 'ğŸ“˜';
}
function rowHtml(item){
  const name = item.name;
  const type = item.type==='dir'? 'í´ë”' : 'íŒŒì¼';
  const size = item.type==='dir'? '-' : formatSize(item.size);
  const openBtn = item.type==='dir'
    ? `<button class="btn" data-open="${encodeURIComponent(item.path)}">ì—´ê¸°</button>`
    : `<a class="btn" href="${item.download_url}" target="_blank">ë‹¤ìš´ë¡œë“œ</a>
       <button class="btn" data-preview='${encodeURIComponent(JSON.stringify({name:item.name,url:item.download_url}))}'>ë¯¸ë¦¬ë³´ê¸°</button>`;
  return `<tr>
    <td class="name click" data-open="${encodeURIComponent(item.path)}">${iconOf(item)} ${name}</td>
    <td class="type">${type}</td>
    <td class="size">${size}</td>
    <td class="right">${openBtn}</td>
  </tr>`;
}
function render(){
  const q = (searchEl.value||'').trim().toLowerCase();
  const items = sortItems(state.items).filter(it => it.name.toLowerCase().includes(q));
  if(!items.length){ listEl.innerHTML = `<tr><td colspan="4" style="padding:12px;color:#888">ë¹„ì–´ ìˆê±°ë‚˜ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`; return }
  listEl.innerHTML = items.map(rowHtml).join('');
}
function renderCrumbs(){
  const parts = state.path ? state.path.split('/') : [];
  crumbsEl.innerHTML = '';
  const root = document.createElement('a');
  root.textContent = `${CONFIG.owner}/${CONFIG.repo}@${CONFIG.branch}`;
  root.href = '#';
  root.onclick = (e)=>{e.preventDefault(); load('')};
  crumbsEl.appendChild(root);
  let cur='';
  parts.forEach((seg)=>{
    const sep = document.createElement('span'); sep.textContent=' â€º '; crumbsEl.appendChild(sep);
    cur += (cur?'/':'') + seg;
    const a = document.createElement('a'); a.textContent = seg; a.href = '#'; a.onclick=(e)=>{e.preventDefault(); load(cur)};
    crumbsEl.appendChild(a);
  });
}

/* ì´ë²¤íŠ¸ */
document.addEventListener('click', (e)=>{
  const open = e.target.closest('[data-open]');
  if(open){
    const path = decodeURIComponent(open.getAttribute('data-open'));
    const isDir = state.items.find(x=>x.path===path)?.type==='dir';
    if(isDir){ load(path); }
    return;
  }
  const pv = e.target.closest('[data-preview]');
  if(pv){
    const data = JSON.parse(decodeURIComponent(pv.getAttribute('data-preview')));
    openPreview(data.name, data.url);
  }
});
function toggleSort(key){
  state.sort.asc = state.sort.key===key ? !state.sort.asc : true;
  state.sort.key = key; render();
}
const sortNameBtn = document.getElementById('sortName');
const sortTypeBtn = document.getElementById('sortType');
const sortSizeBtn = document.getElementById('sortSize');
if (sortNameBtn) sortNameBtn.onclick = ()=> toggleSort('name');
if (sortTypeBtn) sortTypeBtn.onclick = ()=> toggleSort('type');
if (sortSizeBtn) sortSizeBtn.onclick = ()=> toggleSort('size');
if (searchEl) searchEl.addEventListener('input', ()=> render());
const upBtn = document.getElementById('upBtn');
if (upBtn) upBtn.onclick = ()=>{ if(!state.path) return; const up = state.path.split('/').slice(0,-1).join('/'); load(up); };
window.addEventListener('hashchange', ()=>{ const next = decodeURIComponent(location.hash.replace(/^#/,'')); if(next !== state.path){ load(next); } });

/* ë¯¸ë¦¬ë³´ê¸° */
const modal = document.getElementById('previewModal');
const pvTitle = document.getElementById('pvTitle');
const pvBody = document.getElementById('pvBody');
const pvDownload = document.getElementById('pvDownload');
if (modal){
  const pvClose = document.getElementById('pvClose');
  if (pvClose) pvClose.onclick = ()=> modal.classList.remove('open');
  modal.addEventListener('click', (e)=>{ if(e.target===modal) modal.classList.remove('open'); });
}
async function openPreview(name, url){
  if (!modal || !pvTitle || !pvBody || !pvDownload) return window.open(url, '_blank');
  pvTitle.textContent = name;
  pvBody.innerHTML = '<div class="loading">ë¯¸ë¦¬ë³´ê¸° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
  pvDownload.href = url;
  modal.classList.add('open');
  const ext = (name.split('.').pop()||'').toLowerCase();
  const isImg = ['png','jpg','jpeg','gif','webp','bmp','svg','avif'].includes(ext);
  const isPdf = ext==='pdf';
  const isText = ['txt','md','csv','json','js','ts','py','html','css','yml','yaml','xml'].includes(ext);
  try{
    if(isImg){
      pvBody.innerHTML = `<img src="${url}" alt="${name}" />`;
    } else if(isPdf){
      pvBody.innerHTML = `<iframe src="${url}" style="width:100%;height:68vh"></iframe>`;
    } else if(isText){
      const res = await fetch(url+'?nocache='+Date.now());
      const text = await res.text();
      const clipped = text.length>200000 ? text.slice(0,200000) + "\n\n... (ë¯¸ë¦¬ë³´ê¸°ëŠ” 200KBê¹Œì§€ë§Œ í‘œì‹œ)" : text;
      pvBody.innerHTML = `<pre><code></code></pre>`;
      pvBody.querySelector('code').textContent = clipped;
    } else {
      pvBody.innerHTML = `<div class="empty">ì´ í˜•ì‹ì€ ë¸Œë¼ìš°ì € ë¯¸ë¦¬ë³´ê¸°ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ìƒë‹¨ì˜ <b>ë‹¤ìš´ë¡œë“œ</b>ë¥¼ ì´ìš©í•˜ì„¸ìš”.</div>`;
    }
  } catch(err){
    pvBody.innerHTML = `<div class="error">ë¯¸ë¦¬ë³´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ${err.message}</div>`;
  }
}

/* ë¡œë“œ */
async function load(path=''){
  state.path = (path||'').replace(/^\/+|\/+$/g,'');
  if (!listEl) { setDiag('ì˜¤ë¥˜: #list ìš”ì†Œê°€ ì—†ìŒ â€” ìë™ UI ìƒì„± ì‹¤íŒ¨'); return; }
  listEl.innerHTML = `<tr><td colspan="4" class="loading">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>`;
  if (rawBtn) rawBtn.href = ghTreeUrl(state.path, CONFIG.branch);
  setDiag(`ìš”ì²­: ${apiUrl(state.path, CONFIG.branch)}`);

  try {
    const res = await fetch(apiUrl(state.path, CONFIG.branch), { headers: { 'Accept': 'application/vnd.github+json' }});
    if(!res.ok){
      const txt = await res.text().catch(()=> '');
      if(res.status === 404 && !state.branchTried){
        setDiag(`mainì—ì„œ 404 â†’ ê¸°ë³¸ ë¸Œëœì¹˜ ê°ì§€ ì¤‘...`);
        const def = await getDefaultBranch();
        CONFIG.branch = def; state.branchTried = true;
        if (rawBtn) rawBtn.href = ghTreeUrl(state.path, CONFIG.branch);
        setDiag(`ê¸°ë³¸ ë¸Œëœì¹˜=${def} ë¡œ ì¬ì‹œë„`);
        return load(state.path);
      }
      if(res.status === 403 && txt.includes('rate limit')){
        throw new Error('GitHub API ë ˆì´íŠ¸ë¦¬ë°‹(403). ì ì‹œ ë’¤ ìƒˆë¡œê³ ì¹¨ í•˜ì„¸ìš”.');
      }
      if(res.status === 404){
        throw new Error('404: ê²½ë¡œê°€ ì—†ê±°ë‚˜ ë ˆí¬/ë¸Œëœì¹˜ê°€ ë§ì§€ ì•ŠìŠµë‹ˆë‹¤. (Public/ë¸Œëœì¹˜ í™•ì¸)');
      }
      throw new Error(`${res.status} ì‘ë‹µ: ${txt.slice(0,200)}`);
    }
    const data = await res.json();
    state.items = Array.isArray(data) ? data : [];
    render();
    renderCrumbs();
    const hash = '#' + encodeURIComponent(state.path);
    if(location.hash !== hash) history.replaceState({}, '', hash);
    setDiag(`ì„±ê³µ: ${CONFIG.owner}/${CONFIG.repo}@${CONFIG.branch} /${state.path||''}`);
  } catch(err){
    listEl.innerHTML = `<tr><td colspan="4"><div class="error">ëª©ë¡ ì‹¤íŒ¨: ${err.message}</div></td></tr>`;
    setDiag(`ì‹¤íŒ¨: ${err.message}`);
  }
}

/* ì‹œì‘! */
const initPath = decodeURIComponent(location.hash.replace(/^#/,'')); 
load(initPath);
}); // DOMContentLoaded
</script>
