<script>
/* ===== ê°•ì œ ì„¤ì •(ìˆ˜ì •í•˜ì§€ ë§ˆì„¸ìš”) ===== */
const CONFIG = {
  owner: 'shinwbw',
  repo: 'boulderarchive',
  branch: 'main' // ìš°ì„  main ì‹œë„, ì‹¤íŒ¨ ì‹œ ìë™ìœ¼ë¡œ ê¸°ë³¸ ë¸Œëœì¹˜ ê°ì§€
};
/* =================================== */

const state = { path: '', items: [], sort: { key:'name', asc:true }, branchTried:false };
const $ = (sel, el=document) => el.querySelector(sel);
const listEl = $('#list');
const crumbsEl = $('#breadcrumbs');
const searchEl = $('#search');
const rawBtn = $('#rawBtn');

/* == ì§„ë‹¨ ë°•ìŠ¤ ì¶”ê°€ == */
const diag = document.createElement('div');
diag.className = 'hint';
diag.style.marginTop = '8px';
diag.innerHTML = 'ì§„ë‹¨: ì‹œì‘ë¨';
document.querySelector('.wrap').appendChild(diag);

function setDiag(msg){ diag.innerHTML = 'ì§„ë‹¨: ' + msg; }

function apiUrl(path, branch){
  const clean = (path||'').replace(/^\/+|\/+$/g,'');
  const b = encodeURIComponent(branch||CONFIG.branch);
  const n = Date.now();
  return `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${clean}?ref=${b}&nocache=${n}`;
}
function ghTreeUrl(path, branch){
  const clean = (path||'').replace(/^\/+|\/+$/g,'');
  const p = clean? `/tree/${branch}/${clean}` : '';
  return `https://github.com/${CONFIG.owner}/${CONFIG.repo}${p}`;
}

async function getDefaultBranch(){
  const u = `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}?nocache=${Date.now()}`;
  const r = await fetch(u, { headers: { 'Accept': 'application/vnd.github+json' }});
  if(!r.ok) throw new Error(`ë ˆí¬ ì¡°íšŒ ì‹¤íŒ¨ ${r.status}`);
  const j = await r.json();
  return j.default_branch || 'main';
}

async function load(path=''){
  state.path = (path||'').replace(/^\/+|\/+$/g,'');
  listEl.innerHTML = `<tr><td colspan="4" class="loading">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>`;
  rawBtn.href = ghTreeUrl(state.path, CONFIG.branch);
  setDiag(`ìš”ì²­: ${apiUrl(state.path, CONFIG.branch)}`);

  try {
    const res = await fetch(apiUrl(state.path, CONFIG.branch), { headers: { 'Accept': 'application/vnd.github+json' }});
    if(!res.ok){
      // 404/403 ê°™ì€ ê²½ìš° ì›ì¸ ë©”ì‹œì§€ ë…¸ì¶œ
      const txt = await res.text().catch(()=> '');
      if(res.status === 404 && !state.branchTried){
        // mainì´ ì•„ë‹ ìˆ˜ ìˆìŒ â†’ ê¸°ë³¸ ë¸Œëœì¹˜ ìë™ ê°ì§€ í›„ ì¬ì‹œë„
        setDiag(`mainì—ì„œ 404 â†’ ê¸°ë³¸ ë¸Œëœì¹˜ ê°ì§€ ì¤‘...`);
        const def = await getDefaultBranch();
        CONFIG.branch = def;
        state.branchTried = true;
        rawBtn.href = ghTreeUrl(state.path, CONFIG.branch);
        setDiag(`ê¸°ë³¸ ë¸Œëœì¹˜=${def} ë¡œ ì¬ì‹œë„`);
        return load(state.path);
      }
      // ë ˆì´íŠ¸ë¦¬ë°‹ ì•ˆë‚´
      if(res.status === 403 && txt.includes('rate limit')){
        throw new Error('GitHub API ë ˆì´íŠ¸ë¦¬ë°‹(403). ì ì‹œ ë’¤ ìƒˆë¡œê³ ì¹¨ í•˜ì„¸ìš”. (ë§ì´ ëˆŒë €ì„ ë•Œ ë°œìƒ)');
      }
      // í”„ë¼ì´ë¹—/ì—†ëŠ” ê²½ë¡œ/ë¸Œëœì¹˜ ë¶ˆì¼ì¹˜
      if(res.status === 404){
        throw new Error('404: ê²½ë¡œê°€ ì—†ê±°ë‚˜ ë ˆí¬/ë¸Œëœì¹˜ê°€ ë§ì§€ ì•ŠìŠµë‹ˆë‹¤. (ë ˆí¬ Publicì¸ì§€, ë¸Œëœì¹˜ëª… í™•ì¸)');
      }
      throw new Error(`${res.status} ì‘ë‹µ: ${txt.slice(0,200)}`);
    }
    const data = await res.json();
    state.items = Array.isArray(data) ? data : [];
    render();
    renderCrumbs();
    const hash = '#' + encodeURIComponent(state.path);
    if(location.hash !== hash) history.replaceState({}, '', hash);
    setDiag(`ì„±ê³µ: ${CONFIG.owner}/${CONFIG.repo}@${CONFIG.branch} /${state.path||''}`);
  } catch(err){
    listEl.innerHTML = `<tr><td colspan="4"><div class="error">ëª©ë¡ ì‹¤íŒ¨: ${err.message}</div></td></tr>`;
    setDiag(`ì‹¤íŒ¨: ${err.message}`);
  }
}

function renderCrumbs(){
  const parts = state.path ? state.path.split('/') : [];
  crumbsEl.innerHTML = '';
  const root = document.createElement('a');
  root.textContent = `${CONFIG.owner}/${CONFIG.repo}@${CONFIG.branch}`;
  root.href = '#';
  root.onclick = (e)=>{e.preventDefault(); load('')};
  crumbsEl.appendChild(root);
  let cur='';
  parts.forEach((seg)=>{
    const sep = document.createElement('span'); sep.className='sep'; sep.textContent='â€º'; crumbsEl.appendChild(sep);
    cur += (cur?'/':'') + seg;
    const a = document.createElement('a'); a.textContent = seg; a.href = '#'; a.onclick=(e)=>{e.preventDefault(); load(cur)};
    crumbsEl.appendChild(a);
  });
}

function sortItems(items){
  const {key,asc} = state.sort;
  const dir = asc? 1 : -1;
  const isDirFirst = (a,b)=> (a.type===b.type)?0 : (a.type==='dir'?-1:1);
  const byName = (a,b)=> a.name.localeCompare(b.name);
  const byType = (a,b)=> a.type.localeCompare(b.type) || byName(a,b);
  const bySize = (a,b)=> (a.size||0)-(b.size||0) || byName(a,b);
  const cmp = key==='type'? byType : key==='size'? bySize : byName;
  return items.slice().sort((a,b)=> isDirFirst(a,b) || dir*cmp(a,b));
}
function formatSize(bytes){
  if(bytes==null) return '-';
  const units=['B','KB','MB','GB']; let n=bytes, i=0; while(n>=1024 && i<units.length-1){ n/=1024; i++; }
  return (i? n.toFixed(1):n) + ' ' + units[i];
}
function iconOf(item){
  const ext = (item.name.split('.').pop()||'').toLowerCase();
  const isImg = ['png','jpg','jpeg','gif','webp','bmp','svg','avif'].includes(ext);
  const isPdf = ext==='pdf';
  if(item.type==='dir') return 'ğŸ“‚';
  if(isImg) return 'ğŸ–¼ï¸';
  if(isPdf) return 'ğŸ“„';
  return 'ğŸ“˜';
}
function rowHtml(item){
  const name = item.name;
  const type = item.type==='dir'? 'í´ë”' : 'íŒŒì¼';
  const size = item.type==='dir'? '-' : formatSize(item.size);
  const openBtn = item.type==='dir'
    ? `<button class="btn" data-open="${encodeURIComponent(item.path)}">ì—´ê¸°</button>`
    : `<a class="btn" href="${item.download_url}" target="_blank">ë‹¤ìš´ë¡œë“œ</a>
       <button class="btn" data-preview='${encodeURIComponent(JSON.stringify({name:item.name,url:item.download_url}))}'>ë¯¸ë¦¬ë³´ê¸°</button>`;
  return `<tr>
    <td class="name click" data-open="${encodeURIComponent(item.path)}">${iconOf(item)} ${name}</td>
    <td class="type">${type}</td>
    <td class="size">${size}</td>
    <td class="right">${openBtn}</td>
  </tr>`;
}
function render(){
  const q = searchEl.value.trim().toLowerCase();
  const items = sortItems(state.items).filter(it => it.name.toLowerCase().includes(q));
  if(!items.length){ listEl.innerHTML = `<tr><td colspan="4" class="empty">ë¹„ì–´ ìˆê±°ë‚˜ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`; return }
  listEl.innerHTML = items.map(rowHtml).join('');
}

/* ì´ë²¤íŠ¸ */
document.addEventListener('click', (e)=>{
  const open = e.target.closest('[data-open]');
  if(open){
    const path = decodeURIComponent(open.getAttribute('data-open'));
    const isDir = state.items.find(x=>x.path===path)?.type==='dir';
    if(isDir){ load(path); }
    return;
  }
  const pv = e.target.closest('[data-preview]');
  if(pv){
    const data = JSON.parse(decodeURIComponent(pv.getAttribute('data-preview')));
    openPreview(data.name, data.url);
  }
});
$('#sortName').onclick = ()=> toggleSort('name');
$('#sortType').onclick = ()=> toggleSort('type');
$('#sortSize').onclick = ()=> toggleSort('size');
function toggleSort(key){
  state.sort.asc = state.sort.key===key ? !state.sort.asc : true;
  state.sort.key = key;
  $('#sortName').textContent = 'ì´ë¦„' + (state.sort.key==='name' ? (state.sort.asc?' â–²':' â–¼') : '');
  $('#sortType').textContent = 'ìœ í˜•' + (state.sort.key==='type' ? (state.sort.asc?' â–²':' â–¼') : '');
  $('#sortSize').textContent = 'í¬ê¸°' + (state.sort.key==='size' ? (state.sort.asc?' â–²':' â–¼') : '');
  render();
}
searchEl.addEventListener('input', ()=> render());
$('#upBtn').onclick = ()=>{ if(!state.path) return; const up = state.path.split('/').slice(0,-1).join('/'); load(up); };
window.addEventListener('hashchange', ()=>{ const next = decodeURIComponent(location.hash.replace(/^#/,'')); if(next !== state.path){ load(next); } });

/* ë¯¸ë¦¬ë³´ê¸° */
const modal = $('#previewModal');
const pvTitle = $('#pvTitle');
const pvBody = $('#pvBody');
const pvDownload = $('#pvDownload');
$('#pvClose').onclick = ()=> modal.classList.remove('open');
modal.addEventListener('click', (e)=>{ if(e.target===modal) modal.classList.remove('open'); });

async function openPreview(name, url){
  pvTitle.textContent = name;
  pvBody.innerHTML = '<div class="loading">ë¯¸ë¦¬ë³´ê¸° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
  pvDownload.href = url;
  modal.classList.add('open');
  const ext = (name.split('.').pop()||'').toLowerCase();
  const isImg = ['png','jpg','jpeg','gif','webp','bmp','svg','avif'].includes(ext);
  const isPdf = ext==='pdf';
  const isText = ['txt','md','csv','json','js','ts','py','html','css','yml','yaml','xml'].includes(ext);
  try{
    if(isImg){
      pvBody.innerHTML = `<img src="${url}" alt="${name}" />`;
    } else if(isPdf){
      pvBody.innerHTML = `<iframe src="${url}" style="width:100%;height:68vh"></iframe>`;
    } else if(isText){
      const res = await fetch(url+'?nocache='+Date.now());
      const text = await res.text();
      const clipped = text.length>200000 ? text.slice(0,200000) + "\n\n... (ë¯¸ë¦¬ë³´ê¸°ëŠ” 200KBê¹Œì§€ë§Œ í‘œì‹œ)" : text;
      pvBody.innerHTML = `<pre><code></code></pre>`;
      pvBody.querySelector('code').textContent = clipped;
    } else {
      pvBody.innerHTML = `<div class="empty">ì´ í˜•ì‹ì€ ë¸Œë¼ìš°ì € ë¯¸ë¦¬ë³´ê¸°ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ìƒë‹¨ì˜ <b>ë‹¤ìš´ë¡œë“œ</b>ë¥¼ ì´ìš©í•˜ì„¸ìš”.</div>`;
    }
  } catch(err){
    pvBody.innerHTML = `<div class="error">ë¯¸ë¦¬ë³´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ${err.message}</div>`;
  }
}

/* ë¶€íŠ¸ìŠ¤íŠ¸ë© */
(function init(){
  const initPath = decodeURIComponent(location.hash.replace(/^#/,''));
  load(initPath);
})();
</script>
