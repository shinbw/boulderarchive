<script>
/* ===== 강제 설정(수정하지 마세요) ===== */
const CONFIG = {
  owner: 'shinwbw',
  repo: 'boulderarchive',
  branch: 'main' // 우선 main 시도, 실패 시 자동으로 기본 브랜치 감지
};
/* =================================== */

const state = { path: '', items: [], sort: { key:'name', asc:true }, branchTried:false };
const $ = (sel, el=document) => el.querySelector(sel);
const listEl = $('#list');
const crumbsEl = $('#breadcrumbs');
const searchEl = $('#search');
const rawBtn = $('#rawBtn');

/* == 진단 박스 추가 == */
const diag = document.createElement('div');
diag.className = 'hint';
diag.style.marginTop = '8px';
diag.innerHTML = '진단: 시작됨';
document.querySelector('.wrap').appendChild(diag);

function setDiag(msg){ diag.innerHTML = '진단: ' + msg; }

function apiUrl(path, branch){
  const clean = (path||'').replace(/^\/+|\/+$/g,'');
  const b = encodeURIComponent(branch||CONFIG.branch);
  const n = Date.now();
  return `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${clean}?ref=${b}&nocache=${n}`;
}
function ghTreeUrl(path, branch){
  const clean = (path||'').replace(/^\/+|\/+$/g,'');
  const p = clean? `/tree/${branch}/${clean}` : '';
  return `https://github.com/${CONFIG.owner}/${CONFIG.repo}${p}`;
}

async function getDefaultBranch(){
  const u = `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}?nocache=${Date.now()}`;
  const r = await fetch(u, { headers: { 'Accept': 'application/vnd.github+json' }});
  if(!r.ok) throw new Error(`레포 조회 실패 ${r.status}`);
  const j = await r.json();
  return j.default_branch || 'main';
}

async function load(path=''){
  state.path = (path||'').replace(/^\/+|\/+$/g,'');
  listEl.innerHTML = `<tr><td colspan="4" class="loading">불러오는 중...</td></tr>`;
  rawBtn.href = ghTreeUrl(state.path, CONFIG.branch);
  setDiag(`요청: ${apiUrl(state.path, CONFIG.branch)}`);

  try {
    const res = await fetch(apiUrl(state.path, CONFIG.branch), { headers: { 'Accept': 'application/vnd.github+json' }});
    if(!res.ok){
      // 404/403 같은 경우 원인 메시지 노출
      const txt = await res.text().catch(()=> '');
      if(res.status === 404 && !state.branchTried){
        // main이 아닐 수 있음 → 기본 브랜치 자동 감지 후 재시도
        setDiag(`main에서 404 → 기본 브랜치 감지 중...`);
        const def = await getDefaultBranch();
        CONFIG.branch = def;
        state.branchTried = true;
        rawBtn.href = ghTreeUrl(state.path, CONFIG.branch);
        setDiag(`기본 브랜치=${def} 로 재시도`);
        return load(state.path);
      }
      // 레이트리밋 안내
      if(res.status === 403 && txt.includes('rate limit')){
        throw new Error('GitHub API 레이트리밋(403). 잠시 뒤 새로고침 하세요. (많이 눌렀을 때 발생)');
      }
      // 프라이빗/없는 경로/브랜치 불일치
      if(res.status === 404){
        throw new Error('404: 경로가 없거나 레포/브랜치가 맞지 않습니다. (레포 Public인지, 브랜치명 확인)');
      }
      throw new Error(`${res.status} 응답: ${txt.slice(0,200)}`);
    }
    const data = await res.json();
    state.items = Array.isArray(data) ? data : [];
    render();
    renderCrumbs();
    const hash = '#' + encodeURIComponent(state.path);
    if(location.hash !== hash) history.replaceState({}, '', hash);
    setDiag(`성공: ${CONFIG.owner}/${CONFIG.repo}@${CONFIG.branch} /${state.path||''}`);
  } catch(err){
    listEl.innerHTML = `<tr><td colspan="4"><div class="error">목록 실패: ${err.message}</div></td></tr>`;
    setDiag(`실패: ${err.message}`);
  }
}

function renderCrumbs(){
  const parts = state.path ? state.path.split('/') : [];
  crumbsEl.innerHTML = '';
  const root = document.createElement('a');
  root.textContent = `${CONFIG.owner}/${CONFIG.repo}@${CONFIG.branch}`;
  root.href = '#';
  root.onclick = (e)=>{e.preventDefault(); load('')};
  crumbsEl.appendChild(root);
  let cur='';
  parts.forEach((seg)=>{
    const sep = document.createElement('span'); sep.className='sep'; sep.textContent='›'; crumbsEl.appendChild(sep);
    cur += (cur?'/':'') + seg;
    const a = document.createElement('a'); a.textContent = seg; a.href = '#'; a.onclick=(e)=>{e.preventDefault(); load(cur)};
    crumbsEl.appendChild(a);
  });
}

function sortItems(items){
  const {key,asc} = state.sort;
  const dir = asc? 1 : -1;
  const isDirFirst = (a,b)=> (a.type===b.type)?0 : (a.type==='dir'?-1:1);
  const byName = (a,b)=> a.name.localeCompare(b.name);
  const byType = (a,b)=> a.type.localeCompare(b.type) || byName(a,b);
  const bySize = (a,b)=> (a.size||0)-(b.size||0) || byName(a,b);
  const cmp = key==='type'? byType : key==='size'? bySize : byName;
  return items.slice().sort((a,b)=> isDirFirst(a,b) || dir*cmp(a,b));
}
function formatSize(bytes){
  if(bytes==null) return '-';
  const units=['B','KB','MB','GB']; let n=bytes, i=0; while(n>=1024 && i<units.length-1){ n/=1024; i++; }
  return (i? n.toFixed(1):n) + ' ' + units[i];
}
function iconOf(item){
  const ext = (item.name.split('.').pop()||'').toLowerCase();
  const isImg = ['png','jpg','jpeg','gif','webp','bmp','svg','avif'].includes(ext);
  const isPdf = ext==='pdf';
  if(item.type==='dir') return '📂';
  if(isImg) return '🖼️';
  if(isPdf) return '📄';
  return '📘';
}
function rowHtml(item){
  const name = item.name;
  const type = item.type==='dir'? '폴더' : '파일';
  const size = item.type==='dir'? '-' : formatSize(item.size);
  const openBtn = item.type==='dir'
    ? `<button class="btn" data-open="${encodeURIComponent(item.path)}">열기</button>`
    : `<a class="btn" href="${item.download_url}" target="_blank">다운로드</a>
       <button class="btn" data-preview='${encodeURIComponent(JSON.stringify({name:item.name,url:item.download_url}))}'>미리보기</button>`;
  return `<tr>
    <td class="name click" data-open="${encodeURIComponent(item.path)}">${iconOf(item)} ${name}</td>
    <td class="type">${type}</td>
    <td class="size">${size}</td>
    <td class="right">${openBtn}</td>
  </tr>`;
}
function render(){
  const q = searchEl.value.trim().toLowerCase();
  const items = sortItems(state.items).filter(it => it.name.toLowerCase().includes(q));
  if(!items.length){ listEl.innerHTML = `<tr><td colspan="4" class="empty">비어 있거나 검색 결과가 없습니다.</td></tr>`; return }
  listEl.innerHTML = items.map(rowHtml).join('');
}

/* 이벤트 */
document.addEventListener('click', (e)=>{
  const open = e.target.closest('[data-open]');
  if(open){
    const path = decodeURIComponent(open.getAttribute('data-open'));
    const isDir = state.items.find(x=>x.path===path)?.type==='dir';
    if(isDir){ load(path); }
    return;
  }
  const pv = e.target.closest('[data-preview]');
  if(pv){
    const data = JSON.parse(decodeURIComponent(pv.getAttribute('data-preview')));
    openPreview(data.name, data.url);
  }
});
$('#sortName').onclick = ()=> toggleSort('name');
$('#sortType').onclick = ()=> toggleSort('type');
$('#sortSize').onclick = ()=> toggleSort('size');
function toggleSort(key){
  state.sort.asc = state.sort.key===key ? !state.sort.asc : true;
  state.sort.key = key;
  $('#sortName').textContent = '이름' + (state.sort.key==='name' ? (state.sort.asc?' ▲':' ▼') : '');
  $('#sortType').textContent = '유형' + (state.sort.key==='type' ? (state.sort.asc?' ▲':' ▼') : '');
  $('#sortSize').textContent = '크기' + (state.sort.key==='size' ? (state.sort.asc?' ▲':' ▼') : '');
  render();
}
searchEl.addEventListener('input', ()=> render());
$('#upBtn').onclick = ()=>{ if(!state.path) return; const up = state.path.split('/').slice(0,-1).join('/'); load(up); };
window.addEventListener('hashchange', ()=>{ const next = decodeURIComponent(location.hash.replace(/^#/,'')); if(next !== state.path){ load(next); } });

/* 미리보기 */
const modal = $('#previewModal');
const pvTitle = $('#pvTitle');
const pvBody = $('#pvBody');
const pvDownload = $('#pvDownload');
$('#pvClose').onclick = ()=> modal.classList.remove('open');
modal.addEventListener('click', (e)=>{ if(e.target===modal) modal.classList.remove('open'); });

async function openPreview(name, url){
  pvTitle.textContent = name;
  pvBody.innerHTML = '<div class="loading">미리보기 불러오는 중...</div>';
  pvDownload.href = url;
  modal.classList.add('open');
  const ext = (name.split('.').pop()||'').toLowerCase();
  const isImg = ['png','jpg','jpeg','gif','webp','bmp','svg','avif'].includes(ext);
  const isPdf = ext==='pdf';
  const isText = ['txt','md','csv','json','js','ts','py','html','css','yml','yaml','xml'].includes(ext);
  try{
    if(isImg){
      pvBody.innerHTML = `<img src="${url}" alt="${name}" />`;
    } else if(isPdf){
      pvBody.innerHTML = `<iframe src="${url}" style="width:100%;height:68vh"></iframe>`;
    } else if(isText){
      const res = await fetch(url+'?nocache='+Date.now());
      const text = await res.text();
      const clipped = text.length>200000 ? text.slice(0,200000) + "\n\n... (미리보기는 200KB까지만 표시)" : text;
      pvBody.innerHTML = `<pre><code></code></pre>`;
      pvBody.querySelector('code').textContent = clipped;
    } else {
      pvBody.innerHTML = `<div class="empty">이 형식은 브라우저 미리보기를 지원하지 않습니다. 상단의 <b>다운로드</b>를 이용하세요.</div>`;
    }
  } catch(err){
    pvBody.innerHTML = `<div class="error">미리보기에 실패했습니다. ${err.message}</div>`;
  }
}

/* 부트스트랩 */
(function init(){
  const initPath = decodeURIComponent(location.hash.replace(/^#/,''));
  load(initPath);
})();
</script>
